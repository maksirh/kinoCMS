{% extends 'admin_base.html' %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'dist/css/jsvectormap.min.css' %}" />
<div class="container-fluid mt-3">

    <div class="row">

        <div class="col-md-4">
            <div class="card card-danger card-outline">
                <div class="card-header">
                    <h3 class="card-title">Найкращі канали</h3>
                </div>
                <div class="card-body">
                    <canvas id="channelsChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-primary card-outline">
                <div class="card-header">
                    <h3 class="card-title">Сеанси (тиждень)</h3>
                </div>
                <div class="card-body">
                    <canvas id="smallLineChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="small-box bg-warning h-100 d-flex flex-column justify-content-center">
                <div class="inner">
                    <h3>{{ total_users }}</h3>
                    <p>Зареєстрованих користувачів</p>
                </div>
                <div class="icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <a href="#" class="small-box-footer">
                    Детальніше <i class="fas fa-arrow-circle-right"></i>
                </a>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card card-success">
                <div class="card-header">
                    <h3 class="card-title">Динаміка трафіку</h3>
                </div>
                <div class="card-body">
                    <canvas id="bigTrafficChart" style="min-height: 300px; height: 300px; max-height: 300px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row">

        <div class="col-md-8">
            <div class="card bg-gradient-primary">
                <div class="card-header border-0">
                    <h3 class="card-title">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        Відвідувачі
                    </h3>
                </div>
                <div class="card-body">
                    <div id="world-map" style="height: 250px; width: 100%; background: #eee; display: flex; align-items: center; justify-content: center; color: #333;">
                        <span>Тут має бути jVectorMap</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card card-info">
                <div class="card-header">
                    <h3 class="card-title">Стать</h3>
                </div>
                <div class="card-body">
                    <canvas id="genderChart" style="min-height: 250px; height: 250px; max-height: 250px; max-width: 100%;"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<script src="{% static 'dist/js/chart.umd.js' %}"></script>

<script src="{% static 'dist/js/jsvectormap.min.js' %}"></script>
<script src="{% static 'dist/js/world.js' %}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {

        var channelsCtx = document.getElementById('channelsChart').getContext('2d');
        new Chart(channelsCtx, {
            type: 'pie',
            data: {
                labels: {{ channels_labels_json|safe }},
                datasets: [{
                    data: {{ channels_data_json|safe }},
                    backgroundColor: ['#f56954', '#00a65a', '#f39c12', '#00c0ef', '#3c8dbc'],
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                legend: { position: 'left' }
            }
        });

        var smallLineCtx = document.getElementById('smallLineChart').getContext('2d');
        new Chart(smallLineCtx, {
            type: 'line',
            data: {
                labels: {{ dates_json|safe }},
                datasets: [{
                    label: 'Сеанси',
                    data: {{ sessions_json|safe }},
                    borderColor: '#3b8bba',
                    pointBackgroundColor: '#3b8bba',
                    fill: false
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                legend: { display: false },
                scales: {
                    xAxes: [{ gridLines : { display : false } }],
                    yAxes: [{ gridLines : { display : false } }]
                }
            }
        });

        var bigTrafficCtx = document.getElementById('bigTrafficChart').getContext('2d');
        new Chart(bigTrafficCtx, {
            type: 'line',
            data: {
                labels: {{ dates_json|safe }},
                datasets: [
                    {
                        label: 'Всі користувачі',
                        data: {{ sessions_json|safe }},
                        backgroundColor: 'rgba(60,141,188,0.2)',
                        borderColor: 'rgba(60,141,188,1)',
                        pointRadius: false,
                        pointColor: '#3b8bba',
                        pointStrokeColor: 'rgba(60,141,188,1)',
                        pointHighlightFill: '#fff',
                        pointHighlightStroke: 'rgba(60,141,188,1)',
                        fill: true
                    }
                ]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
                tooltips: { mode: 'index', intersect: false },
                hover: { mode: 'nearest', intersect: true },
                scales: {
                    xAxes: [{ gridLines : { display : false } }],
                    yAxes: [{ gridLines : { display : false } }]
                }
            }
        });

        var genderCtx = document.getElementById('genderChart').getContext('2d');
        new Chart(genderCtx, {
            type: 'doughnut',
            data: {
                labels: ['Чоловіки', 'Жінки'],
                datasets: [{
                    data: {{ gender_data_json|safe }},
                    backgroundColor: ['#3c8dbc', '#d2d6de'],
                }]
            },
            options: {
                maintainAspectRatio: false,
                responsive: true,
            }
        });

        const mapElement = document.getElementById('world-map');
        if (mapElement) {
            mapElement.innerHTML = '';
            const mapData = {{ map_data_json|safe }};

            const map = new jsVectorMap({
                selector: '#world-map',
                map: 'world',
                zoomButtons: true,
                zoomOnScroll: false,
                regionStyle: {
                    initial: {
                        fill: '#e4e4e4',
                        "fill-opacity": 1,
                        stroke: 'none',
                        "stroke-width": 0,
                        "stroke-opacity": 1
                    },
                    hover: {
                        fill: '#ccc'
                    },
                    selected: {
                        fill: '#c9dfaf'
                    }
                },
                visualizeData: {
                    scale: ['#eeeeee', '#007bff'],
                    values: mapData
                },
                onRegionTooltipShow(event, tooltip, code) {
                    const count = mapData[code] || 0;
                    tooltip.text(
                        tooltip.text() + ` (Відвідувачів: ${count})`
                    );
                }
            });
        }
    });
</script>
{% endblock %}