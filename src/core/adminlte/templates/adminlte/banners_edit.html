{% extends "admin_base.html" %}
{% load static %}
{% block content %}
<style>
  .comp-card{
    position:relative; border:2px solid #6c757d; border-radius:8px; padding:12px; width:220px; background:#f8f9fa;
  }

   .file-holder input[type="file"]{
    position:absolute; left:-9999px; width:1px; height:1px; opacity:0;
  }
  .preview-box { pointer-events:none; }
   .comp-card textarea {
    min-height: 96px;
    max-width: 100%;
    min-width: 100%;
    resize: vertical;
  }
  .comp-grid{
    display:flex; flex-wrap:wrap; gap:16px;
  }
  .preview-box{
    height:110px; background:#e9ecef; border:2px solid #495057; border-radius:6px;
    display:flex; align-items:center; justify-content:center; color:#6c757d; font-size:14px;
    background-image:url("{% static 'img/placeholder-image.svg' %}");
    background-repeat:no-repeat; background-position:center; background-size:64px 64px;
  }
  .close-x{
    position:absolute; right:-8px; top:-8px; width:26px; height:26px; border-radius:50%;
    background:#212529; color:#fff; border:2px solid #fff; display:flex; align-items:center; justify-content:center;
    font-weight:700; cursor:pointer; line-height:1;
  }
  .add-btn{ width:100%; }
  .mini-label{ font-size:12px; color:#6c757d; }
  .side-add{
    display:flex; align-items:center; justify-content:center; width:90px; height:110px;
    border:2px dashed #6c757d; border-radius:8px; background:#f8f9fa; cursor:pointer; text-align:center; padding:8px;
  }
  .switch {
    position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle;
  }
  .switch input {display:none;}
  .slider {
    position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
    background-color: #dee2e6; transition: .2s; border-radius: 24px;
  }
  .slider:before {
    position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px;
    background-color: white; transition: .2s; border-radius: 50%;
  }
  .switch input:checked + .slider { background-color: #28a745; }
  .switch input:checked + .slider:before { transform: translateX(20px); }
</style>

<div class="container mt-4">
  <h2 class="mb-3">Верхній банер на головній</h2>

  <form method="post" enctype="multipart/form-data" action="{% url 'adminlte:banners_top_update' %}">
    {% csrf_token %}

    <div class="card p-3 mb-3">s
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><span class="mini-label">Розмір:</span> <strong>1000x190</strong></div>
        <div class="d-flex align-items-center gap-2">
          <span class="mini-label">Активний</span>
          <label class="switch">
            {{ form_top.is_active.as_widget|safe }}
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Швидкість обертання</label>
          {{ form_top.speed }}
          {{ form_top.speed.errors }}
        </div>
      </div>
    </div>


    <div class="card p-3">
      <h5 class="mb-3">Компоненти</h5>

      {{ formset_top.management_form }}
      {% if formset_top.non_form_errors %}
        <div class="alert alert-danger">{{ formset_top.non_form_errors }}</div>
      {% endif %}

      <div class="comp-grid" id="grid-top">
        {% for f in formset_top %}
          {% for h in f.hidden_fields %}{{ h }}{% endfor %}
          <div class="comp-card component-item" data-index="{{ forloop.counter0 }}">
            <div class="close-x" title="Видалити" onclick="markDelete(this)">×</div>

            <div class="preview-box mb-2" data-preview>
                {% if f.instance.pk and f.instance.image %}
                <img src="{{ f.instance.image.url }}" alt="" style="max-width:100%;max-height:100%;object-fit:contain;">
            {% else %}
                Попередній перегляд
            {% endif %}
            </div>

            <button class="btn btn-secondary btn-sm add-btn mb-2" type="button" onclick="chooseFile(this)">Додати</button>

            <div class="mb-2">
              <span class="mini-label">URL:</span>
              {{ f.url|default_if_none:"" }}
              {{ f.url.errors }}
            </div>
            <div class="mb-2">
              <span class="mini-label">Текст:</span>
              {{ f.text|default_if_none:"" }}
              {{ f.text.errors }}
            </div>


            <div class="file-holder">
              {{ f.image }}
              {{ f.image.errors }}
            </div>

            {% if f.DELETE %}
              <div class="d-none delete-holder">{{ f.DELETE }}</div>
            {% endif %}
          </div>
        {% endfor %}

        <div class="side-add" id="add-photo" onclick="addForm('top_items', 'grid-top', 'template-top')">Додати<br>фото</div>
      </div>
    </div>

    <div class="text-center my-3">
      <button type="submit" class="btn btn-primary px-4">Зберегти</button>
    </div>

    <template id="template-top">
      {% with ef=formset_top.empty_form %}
      <div class="comp-card component-item">
        <div class="close-x" title="Видалити" onclick="markDelete(this)">×</div>
        <div class="preview-box mb-2" data-preview>Попередній перегляд</div>
        <button class="btn btn-secondary btn-sm add-btn mb-2" type="button" onclick="chooseFile(this)">Додати</button>

        <div class="mb-2">
          <span class="mini-label">URL:</span>
          {{ ef.url }}
        </div>
        <div class="mb-2">
          <span class="mini-label">Текст:</span>
          {{ ef.text }}
        </div>

        <div class="file-holder">
          {{ ef.image }}
        </div>
        {% if ef.DELETE %}
          <div class="d-none delete-holder">{{ ef.DELETE }}</div>
        {% endif %}

        {% for h in ef.hidden_fields %}{{ h }}{% endfor %}
      </div>
      {% endwith %}
    </template>

  </form>

    <h2 class="mb-3">Сквозний банер</h2>

    <form method="post" enctype="multipart/form-data" action="{% url 'adminlte:banners_through_update' %}">
  {% csrf_token %}

  <div class="card p-3 mb-3">
    <h5 class="mb-3">Налаштування наскрізного банера</h5>
    <div class="d-flex justify-content-between align-items-center">

      <div class="d-flex align-items-center gap-2">
        <span class="mini-label">Колір фону:</span>
        {{ form_through.background }} </div>

      <div class="d-flex align-items-center gap-2">
        <span class="mini-label">Активний</span>
        <label class="switch">
          {{ form_through.is_active.as_widget|safe }}
          <span class="slider"></span>
        </label>
      </div>

    </div>
  </div>

<div class="card p-3">
  <h5 class="mb-3">Зображення</h5>

  {{ formset_through.management_form }}

  <div class="comp-grid" id="grid-through">
      {% for f in formset_through %}
  {% for h in f.hidden_fields %}{{ h }}{% endfor %}

  <div class="comp-card component-item" style="width: 100%; max-width: 350px;">

    <div class="preview-box mb-2" data-preview style="height: 180px; overflow: hidden;">
        {% if f.instance.pk and f.instance.image %}
          <img src="{{ f.instance.image.url }}" style="width:100%; height:100%; object-fit:cover;">
        {% else %}
          <span class="text-muted">Зображення відсутнє</span>
        {% endif %}
    </div>

    <div class="d-flex gap-2">
        <button class="btn btn-secondary btn-sm w-50" type="button" onclick="chooseFile(this)">
             {% if f.instance.image %}Змінити{% else %}Обрати фото{% endif %}
        </button>

        <button class="btn btn-danger btn-sm w-50" type="button" onclick="clearImage(this)"
                {% if not f.instance.image %}disabled{% endif %}>
             Видалити
        </button>
    </div>

    <div class="file-holder d-none">
      {{ f.image }}
    </div>

  </div>
{% endfor %}
  </div>
</div>

  <div class="text-center my-3">
    <button type="submit" class="btn btn-primary px-4">Зберегти</button>
  </div>

</form>

    <h2 class="mb-3">Новини та акції</h2><form method="post" enctype="multipart/form-data" action="{% url 'adminlte:news_banner_update' %}">
    {% csrf_token %}

    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <div><span class="mini-label">Розмір:</span> <strong>1000x190</strong></div>
        <div class="d-flex align-items-center gap-2">
          <span class="mini-label">Активний</span>
          <label class="switch">
            {{ form_news.is_active.as_widget|safe }}
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="row g-3 align-items-end">
        <div class="col-md-3">
          <label class="form-label">Швидкість обертання</label>
          {{ form_news.speed }}
          {{ form_news.speed.errors }}
        </div>
      </div>
    </div>


    <div class="card p-3">
      <h5 class="mb-3">Компоненти</h5>

      {{ formset_news.management_form }}
      {% if formset_news.non_form_errors %}
        <div class="alert alert-danger">{{ formset_news.non_form_errors }}</div>
      {% endif %}

      <div class="comp-grid" id="grid-news">
        {% for f in formset_news %}
          {% for h in f.hidden_fields %}{{ h }}{% endfor %}
          <div class="comp-card component-item" data-index="{{ forloop.counter0 }}">
            <div class="close-x" title="Видалити" onclick="markDelete(this)">×</div>

            <div class="preview-box mb-2" data-preview>
                {% if f.instance.pk and f.instance.image %}
                <img src="{{ f.instance.image.url }}" alt="" style="max-width:100%;max-height:100%;object-fit:contain;">
            {% else %}
                Попередній перегляд
            {% endif %}
            </div>

            <button class="btn btn-secondary btn-sm add-btn mb-2" type="button" onclick="chooseFile(this)">Додати</button>

            <div class="mb-2">
              <span class="mini-label">URL:</span>
              {{ f.url|default_if_none:"" }}
              {{ f.url.errors }}
            </div>


            <div class="file-holder">
              {{ f.image }}
              {{ f.image.errors }}
            </div>

            {% if f.DELETE %}
              <div class="d-none delete-holder">{{ f.DELETE }}</div>
            {% endif %}
          </div>
        {% endfor %}

        <div class="side-add" id="add-photo" onclick="addForm('news_items', 'grid-news', 'template-news')">Додати<br>фото</div>
      </div>
    </div>

    <div class="text-center my-3">
      <button type="submit" class="btn btn-primary px-4">Зберегти</button>
    </div>

    <template id="template-news">
      {% with ef=formset_news.empty_form %}
      <div class="comp-card component-item">
        <div class="close-x" title="Видалити" onclick="markDelete(this)">×</div>
        <div class="preview-box mb-2" data-preview>Попередній перегляд</div>
        <button class="btn btn-secondary btn-sm add-btn mb-2" type="button" onclick="chooseFile(this)">Додати</button>

        <div class="mb-2">
          <span class="mini-label">URL:</span>
          {{ ef.url }}
        </div>

        <div class="file-holder">
          {{ ef.image }}
        </div>
        {% if ef.DELETE %}
          <div class="d-none delete-holder">{{ ef.DELETE }}</div>
        {% endif %}

        {% for h in ef.hidden_fields %}{{ h }}{% endfor %}
      </div>
      {% endwith %}
    </template>

  </form>

</div>

<script>
  function chooseFile(btn){
    const card = btn.closest('.comp-card');
    const fileInput = card.querySelector('.file-holder input[type="file"]');
    if (fileInput){
      fileInput.click();
      fileInput.onchange = () => renderPreview(card, fileInput);
    }
  }

  function renderPreview(card, fileInput){
    const preview = card.querySelector('[data-preview]');
    const file = fileInput.files && fileInput.files[0];
    if (file){
      const reader = new FileReader();
      reader.onload = e => {
         preview.style.backgroundImage = 'none';
         preview.innerHTML = `<img src="${e.target.result}" style="max-width:100%;max-height:100%;object-fit:contain;">`;
      };
      reader.readAsDataURL(file);
    }
  }

  function clearImage(btn) {
    const card = btn.closest('.comp-card');
    const preview = card.querySelector('[data-preview]');
    const fileInput = card.querySelector('.file-holder input[type="file"]');

    const clearCheckbox = card.querySelector('.file-holder input[type="checkbox"]');

    if (clearCheckbox) {
        clearCheckbox.checked = true;
    }

    if (fileInput) {
        fileInput.value = "";
    }

    preview.innerHTML = '<span class="text-danger">Буде видалено після збереження</span>';

    btn.disabled = true;
}

  function markDelete(el){
    const card = el.closest('.comp-card');
    const del = card.querySelector('.delete-holder input[type="checkbox"]');

    if (del){
      del.checked = true;
      card.style.display = 'none';
    } else {

      const input = card.querySelector('input, select, textarea');
      if (input) {
          const nameParts = input.name.split('-');
          const prefix = nameParts[0];

          const total = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
          if (total) {
              total.value = Number(total.value) - 1;
          }
      }

      card.remove();
    }
  }

  function addForm(prefix, gridId, templateId){
    const tmpl = document.getElementById(templateId).content.cloneNode(true);
    const grid = document.getElementById(gridId);
    const addButton = grid.querySelector('.side-add');

    const total = document.getElementById(`id_${prefix}-TOTAL_FORMS`);
    const index = Number(total.value);

    tmpl.querySelectorAll('[name],[id],[for]').forEach(el=>{
      if (el.name) el.name = el.name.replace('__prefix__', index);
      if (el.id)   el.id   = el.id.replace('__prefix__', index);
      if (el.getAttribute('for')){
        el.setAttribute('for', el.getAttribute('for').replace('__prefix__', index));
      }
    });

    total.value = index + 1;
    grid.insertBefore(tmpl, addButton);
  }

  document.querySelectorAll('.comp-card .file-holder input[type="file"]').forEach(inp=>{
    const card = inp.closest('.comp-card');
    inp.addEventListener('change', ()=>renderPreview(card, inp));
  });
</script>
{% endblock %}
